<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
</head>
<body>
<canvas id="avatarCanvas" style="display:none"></canvas>

<script>
const corsProxy = 'https://api.cors.lol/?url=';

function getUsernameFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get('username');
}

async function fetchTikTokAvatar(username) {
  const tiktokUrl = `https://www.tiktok.com/@${encodeURIComponent(username)}`;
  const proxiedUrl = corsProxy + encodeURIComponent(tiktokUrl);

  const res = await fetch(proxiedUrl);
  if (!res.ok) throw new Error('Failed to fetch TikTok page');

  const html = await res.text();

  const match = html.match(/"avatarLarger"\s*:\s*"([^"]+)"/) 
             || html.match(/"avatarMedium"\s*:\s*"([^"]+)"/)
             || html.match(/<meta\s+property=["']og:image["']\s+content=["']([^"']+)["']/i);

  if (!match) return null;

  let avatarUrl = match[1].replace(/\\\//g,'/');
  if (avatarUrl.startsWith('//')) avatarUrl = 'https:' + avatarUrl;
  return avatarUrl;
}

function drawCircularImage(img) {
  const size = 300;
  const canvas = document.getElementById('avatarCanvas');
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext('2d');

  ctx.beginPath();
  ctx.arc(size/2, size/2, size/2, 0, Math.PI*2);
  ctx.closePath();
  ctx.clip();

  const scale = Math.max(size / img.width, size / img.height);
  const sw = size / scale;
  const sh = size / scale;
  const sx = (img.width - sw)/2;
  const sy = (img.height - sh)/2;

  ctx.drawImage(img, sx, sy, sw, sh, 0, 0, size, size);
  canvas.style.display = 'block';
}

async function main() {
  const username = getUsernameFromURL();
  if (!username) return;

  try {
    const avatarUrl = await fetchTikTokAvatar(username);
    if (!avatarUrl) return;

    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => drawCircularImage(img);
    img.src = corsProxy + encodeURIComponent(avatarUrl);
  } catch (e) {
    console.error(e);
  }
}

main();
</script>
</body>
</html>
